<!DOCTYPE html>
<html>
<head>
  <title>StarlingX Demo</title>
  <script src="./Chart.js"></script>
  <meta name = "viewport" content = "initial-scale = 1, user-scalable = no">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/static/bootstrap-4.3.1/css/bootstrap.css">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> 
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon_32.png">
  <script src="/static/jquery-3.3.1.js"></script>

  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=McBgrGTKsFTNKtlxLZLdWrmzfQYQ35DI"></script>
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>

  <style>
  .btn-circle.btn-xl {
    width: 70px;
    height: 70px;
    padding: 10px 16px;
    border-radius: 35px;
    font-size: 24px;
    line-height: 1.33;
}
  .btn-circle.btn-lg {
    width: 50px;
    height: 50px;
    padding: 8px 13px;
    border-radius: 30px;
    font-size: 20px;
    line-height: 1.33;
}

.btn-circle {
    width: 30px;
    height: 30px;
    padding: 6px 0px;
    border-radius: 15px;
    text-align: center;
    font-size: 12px;
    line-height: 1.42857;
}
#allmap{width:1300px;height:400px;}
</style>
</head>

<body>

<!-- StarlingX Heading -->
<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #685BC7">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="/" style="color: white; font-size:2.5em"><img src="/static/img/logo_white.png" width="52px" height="45px"><span class="ml-3">StarlingX - UnionPay E-charger Demo</span></a>
      </li>
    </ul>
  </div>
</nav>

<!-- Info and Map -->
<div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
			<div class="row clearfix">
				<div class="col-md-12 column">
            <p>&nbsp;</p>
            <div style="font-weight: 800">
				中国银联唐镇园区充电站
            </div>
            
			<div class="table-a"> 
              <p><table width="1200" border="0" cellspacing="0" cellpadding="0"> 
              <tr> 
                <td width="300">站点编号：EDGE01234</td> 
                <td width="300">所属业主：深电能售电有限公司</td> 
                <td width="300">所属物业：车电网123355</td> 
                <td width="300">变压类型：公变</td> 
              </tr> 
              <tr> 
                <td width="300">接口类型：国际交流</td> 
                <td width="300">营业时段：0：00-24：00</td> 
                <td width="300">停车场收费标准：免费</td> 
                <td width="300">站点地址：顾唐路1699号</td>
              </tr> 
              <tr> 
                <td width="300">联系人：John</td> 
                <td width="300">联系电话：15812345678</td> 
                <td width="300">站使用率：20%</td> 
                <td width="300">站月使用率：12%</td>
              </tr> 
            </table></p> 
			</div>
         </div>
	     <div id="allmap"></div>			
		</div>
	</div>
</div>
</div>

<div>&nbsp;</div>

<!-- Data Analysis -->
<div class="container">
	<div class="row clearfix">
		<div class="col-md-6 column">
			<div style="font-weight: 800">
                图表分析1
            </div><canvas id="canvas_circle" width="450" height="200" style="border:0px solid #0026ff;">  
                浏览器不支持canvas  
            </canvas>
          
		<div class="col-md-6 column">
			<div style="font-weight: 800">
                图表分析2
            </div><img alt="140x140" src="/static/img/000.png" height="200" width="450"/>
		</div>
	</div>
</div>

<div>&nbsp;</div>

<!-- History table -->
<div class="container">
	<div style="font-weight: 800">历史账单数据一览</div>
	<div class="row clearfix">
		<div class="col-md-12 column">
			<table class="table" id = "history_table">
				<thead>
					<tr>
						<th>日期</th>
						<th>结算时间</th>
						<th>停放地点</th>
						<th>用户ID</th>
						<th>充电量</th>
						<th>结算金额</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>2019/10/12</td>
						<td>10:46:23</td>
						<td>中国银联唐镇园区充电站</td>
						<td>123f003839304d4587722816</td>
						<td>15kwh</td>
						<td>5元</td>
					</tr>
					<tr>
						<td>2019/10/12</td>
						<td>11:55:11</td>
						<td>英特尔亚太研发充电站</td>
						<td>066f003839304d3143022816</td>
						<td>30kwh</td>
						<td>8元</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<!-- No use tricks -->
<div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
        <textarea rows="16" class="form-control mt-4 mb-2 ml-2 col-11" id="ele_messages" style="font-size: 0.7rem"></textarea>
    </div>
  </div>
</div>

<div class="container-fluid">
    <div class="row-fluid">
      <div class="span6">
         <button class="btn" type="button" onclick=clickHandler_map()>Map</button>
      </div>
      <div class="span6">
         <button class="btn" type="button" onclick=clickHandler_his()>History</button>
      </div>
    </div>
</div>

<!-- Charts -->
<canvas id="canvas" height="300" width="950"></canvas>



<script language="javascript">
var clickHandler_map = function(){
  publish("charger/map_information",'{"in_use":"3","in_appoint":"2","in_repair":"1","total_elec":"2000.32","whole_money":"8432.4"}')
}

var clickHandler_his = function(){
  publish("charger/charger_information",'{"date":"2019/08/20", "Endtime":"15:42", "Place":"Intel", "carPlate":"Shanghai888","stayTime":"5min", "electricity":"0.18kWh", "money":"23" }')
}

</script>


<!-- MQTT JS -->

<script language="javascript">
var database_his;

$.ajax({
        type:"GET",
        url:'http://10.239.153.146:5000/sendHistory',
        async:false,
        dataType:"list",
        crossDomain:true,
        success:function(data){
          database_his = data
          console.log(database_his)
          // var i;
          // for (i = 0; i < database_his.length; i++) {
          //   $("#history_table").append("<tr>"
          //    + "<td>" + database_his[i][6][0:4]  + "</td>"
          //    + "<td>" +  + "</td>"
          //    + "<td>" + "中国银联唐镇园区充电站" + "</td>"
          //    + "<td>" +  + "</td>"
          //    + "<td>" +  + "</td>"
          //    + "<td>" +  + "元" + "</td>");
          // }
        }
});

</script>


<script language="javascript">
  var in_use = "0", in_appoint = "0", in_repair = "0", total_elec = "0", whole_money = "0"; //Used in mapInfo
  var setup_ws = function() {
  var host = window.location.host;
  var parsedUrl = new URL(window.location.href);
  var ws = new WebSocket('ws://'+host+'/ws');
  var $message = $('#message');

  ws.onopen = function(){
  };
  ws.onmessage = function(ev){
    var json = JSON.parse(ev.data);
    console.log("json = ", json);

    if (json.action === "conn") {
      //$message.text(json.status);
      operation_log("connection status: " + json.status);
      if (json.status === "connected") {
        subscribe("charger/charger_information");
        subscribe("charger/map_information");
      }
    } else if (json.action === "topic") {
      if (json.message) {
        msgdiv = document.getElementById('ele_messages');
        msgdiv.append('>> ' + json.topic + ': ' + JSON.stringify(json.message, null, 2) + '\n');
        msgdiv.scrollTop = msgdiv.scrollHeight; //Just set the message scroll so that can be look pretty
        var msgJson = json.message;
        if(json.topic === "charger/charger_information"){
          $("#history_table").append("<tr>"
             + "<td>" + msgJson.date + "</td>"
             + "<td>" + msgJson.Endtime + "</td>"
             + "<td>" + "中国银联唐镇园区充电站" + "</td>"
             + "<td>" + "沪A88888" + "</td>"
             + "<td>" + msgJson.stayTime + "</td>"
             + "<td>" + msgJson.electricity + "</td>"
             + "<td>" + msgJson.money + "元" + "</td>");
        }
        if(json.topic === "charger/map_information"){
          in_use = msgJson.in_use;
          in_appoint = msgJson.in_appoint;
          in_repair = msgJson.in_repair;
          total_elec = msgJson.total_elec;
          whole_money = msgJson.whole_money;
          infoWindow.setContent("使用中:" + in_use + "&nbsp; 预约中:" + in_appoint + "&nbsp; 维修中:" + in_repair + " <br>  累计充电:" + total_elec 
                                    + "kWh <br> 累计服务费:" + whole_money + "元")
        }
      }
    }

  };
  ws.onclose = function(ev){
  };
  ws.onerror = function(ev){
  };
};


var subscribe = function(channel) {
    var data = {
      topic: channel
    };
    operation_log("... " + channel + ": subscribing ...");
    console.log("post sub " + JSON.stringify(data));
    $.post('sub', data).done(function() {
      operation_log("... " + channel + ": subscribe successfully.");
    }).fail(function(error){
      operation_log("... " + channel + ": subscribe failed.");
      console.log(error);
    });
};

var publish = function(channel, msg) {
    var data = {
      topic: channel,
      message: msg
    };
    operation_log("... " + channel + ": publishing ...");
    console.log("post pub " + JSON.stringify(data));
    $.post('pub', data).done(function() {
      operation_log("... " + channel + ": publish successfully.");
    }).fail(function(error){
      operation_log("... " + channel + ": publish failed.");
      console.log(error);
    });
};

var operation_log = function(logmsg) {
  console.log(logmsg);
};


$(document).ready(function() {
  
  setup_ws();
  var server_addr = '192.168.100.1';
  var server_port = 1883;
  var data = {
    addr: server_addr,
    port: server_port
  };
  console.log(data);
  $.post('api', data).done(function() {
      operation_log(server_addr + ":" + server_port + ": connecting");
  }).fail(function(error){
      operation_log(server_addr + ":" + server_port + ": connect failed");
      console.log(error);
  });  
});
  
</script>

<!-- Baidu Map JS -->
<script language="javascript">
  map = new BMap.Map("allmap");
  var pointx=121.6695771291;
  var pointy=31.2398275739;
  var point = new BMap.Point(pointx,pointy);
  var marker = new BMap.Marker(point);  // 创建标注
  map.addOverlay(marker);              // 将标注添加到地图中
  map.centerAndZoom(point, 15);
  map.centerAndZoom(new BMap.Point(pointx,pointy), 15);
  var opts = {
  width : 230,     // 信息窗口宽度
  height: 100,     // 信息窗口高度
  title : "中国银联唐镇园区充电站" , // 信息窗口标题
  enableMessage:true,//设置允许信息窗发送短息
  message:"欢迎您的使用！"
  }
  var infoWindow = new BMap.InfoWindow("使用中:" + in_use + "&nbsp; 预约中:" + in_appoint + "&nbsp; 维修中:" + in_repair + " <br>  累计充电:" + total_elec 
                                    + "kWh <br> 累计服务费:" + whole_money + "元", opts);  // 创建信息窗口对象 
  marker.addEventListener("click", function(){          
    map.openInfoWindow(infoWindow,point); //开启信息窗口
  });
  // map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
  // map.enableDragging();
</script>
 
 <script>function drawCircle(canvasId, data_arr, color_arr, text_arr)  
            {  
                var c = document.getElementById(canvasId);  
                var ctx = c.getContext("2d");  
  
                var radius = c.height / 2 - 20; //半径  
                var ox = radius + 20, oy = radius + 20; //圆心  
  
                var width = 30, height = 10; //图例宽和高  
                var posX = ox * 2 + 20, posY = 30;   //  
                var textX = posX + width + 5, textY = posY + 10;  
  
                var startAngle = 0; //起始弧度  
                var endAngle = 0;   //结束弧度  
                for (var i = 0; i < data_arr.length; i++)  
                {  
                    //绘制饼图  
                    endAngle = endAngle + data_arr[i] * Math.PI * 2; //结束弧度  
                    ctx.fillStyle = color_arr[i];  
                    ctx.beginPath();  
                    ctx.moveTo(ox, oy); //移动到到圆心  
                    ctx.arc(ox, oy, radius, startAngle, endAngle, false);  
                    ctx.closePath();  
                    ctx.fill();  
                    startAngle = endAngle; //设置起始弧度  
  
                    //绘制比例图及文字  
                    ctx.fillStyle = color_arr[i];  
                    ctx.fillRect(posX, posY + 20 * i, width, height);  
                    ctx.moveTo(posX, posY + 20 * i);  
                    ctx.font = 'bold 12px 微软雅黑';    //斜体 30像素 微软雅黑字体  
                    ctx.fillStyle = color_arr[i]; //"#000000";  
                    var percent = text_arr[i] + "：" + 100 * data_arr[i] + "%";  
                    ctx.fillText(percent, textX, textY + 20 * i);  
                }  
            }  
  
            function init() {  
                //绘制饼图  
                //比例数据和颜色  
                var data_arr = [0.1, 0.2, 0.3, 0.4];  
                var color_arr = ["#BA55D3", "#DDA0DD", "#4B0082", "#D8BFD8"];  
                var text_arr = ["设备使用", "设备空闲", "设备维修", "设备离线"];  
  
                drawCircle("canvas_circle", data_arr, color_arr, text_arr);  
            }  
  
            //页面加载时执行init()函数  
            window.onload = init;  
</script>

</body>
</html>

